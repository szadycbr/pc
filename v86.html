<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>v86 Emulator - Single Page UI</title>
<style>
html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
    font-family: sans-serif;
    background: #f4f4f4;
}
#main-layout {
    display: flex;
    flex-direction: column;
    height: 100vh;
    width: 100vw;
}
#emu-area {
    flex: 1 1 auto;
    display: flex;
    flex-direction: row;
    min-height: 0;
    min-width: 0;
    overflow: hidden;
}
#controls-panel {
    width: 270px;
    background: #eaeaea;
    padding: 16px 10px 16px 10px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    align-items: stretch;
    overflow-y: auto;
    border-right: 1px solid #ccc;
    min-width: 220px;
    max-width: 350px;
}
#controls-panel > div, #controls-panel > hr {
    margin-bottom: 10px;
    margin-top: 0;
}
#controls-panel label {
    margin-right: 6px;
    font-size: 1em;
}
#controls-panel select, #controls-panel input[type="checkbox"], #controls-panel input[type="range"], #controls-panel button {
    margin: 2px 0 2px 0;
}
#controls-panel button {
    padding: 6px 12px;
    font-size: 1em;
    margin-right: 5px;
    margin-bottom: 5px;
}
#controls-panel input[type="file"] {
    font-size: 1em;
}
#display-block {
    flex: 1 1 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    min-width: 0;
    min-height: 0;
    width: 0;
    height: 100%;
    overflow: hidden;
}
#top-controls {
    width: 100%;
    max-width: 100vw;
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin: 18px 0 6px 0;
}
#screen_aspect_wrapper {
    width: 100%;
    height: 100%;
    display: flex;
    flex: 1 1 auto;
    justify-content: center;
    align-items: center;
    overflow: hidden;
}
#screen_container {
    position: relative;
    background: #000;
    border: 1px solid #ccc;
    box-sizing: border-box;
    width: 100%;
    height: 100%;
    max-width: 100%;
    max-height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}
#screen_container > canvas,
#screen_container > div {
    width: 100% !important;
    height: 100% !important;
    max-width: 100% !important;
    max-height: 100% !important;
    display: block;
    object-fit: fill;
}
#status-container {
    height: 32px;
    line-height: 32px;
    background: #e9e9e9;
    border-top: 1px solid #ccc;
    text-align: center;
    font-size: 0.93em;
    font-style: italic;
    flex-shrink: 0;
}
@media (max-width: 1100px) {
    #controls-panel { width: 160px; font-size: 0.96em; }
    #top-controls { width: 100%; }
}
</style>
</head>
<body>
<div id="main-layout">
    <div id="emu-area">
        <div id="controls-panel">
            <div>
                <label for="enable-sound-checkbox">Enable Sound:</label>
                <input type="checkbox" id="enable-sound-checkbox" checked>
            </div>
            <div>
                <label for="brightness-slider">Brightness:</label>
                <input type="range" id="brightness-slider" min="0.5" max="1.5" step="0.1" value="1">
            </div>
            <hr>
            <!-- SB16 options -->
            <div>
                <label for="sb16-irq-select">SB16 IRQ:</label>
                <select id="sb16-irq-select">
                    <option value="5" selected>5</option>
                    <option value="7">7</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                </select>
            </div>
            <div>
                <label for="sb16-dma8-select">SB16 DMA 8-bit:</label>
                <select id="sb16-dma8-select">
                    <option value="0">0</option>
                    <option value="1" selected>1</option>
                    <option value="3">3</option>
                </select>
            </div>
            <div>
                <label for="sb16-dma16-select">SB16 DMA 16-bit:</label>
                <select id="sb16-dma16-select">
                    <option value="5" selected>5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                </select>
            </div>
            <div>
                <label for="sb16-port-select">SB16 Port:</label>
                <select id="sb16-port-select">
                    <option value="0x220" selected>0x220</option>
                    <option value="0x240">0x240</option>
                    <option value="0x260">0x260</option>
                </select>
            </div>
            <hr>
            <div>
                <label for="custom-bios-file-input">Custom BIOS:</label>
                <input type="file" id="custom-bios-file-input" accept=".bin" style="display: none;">
                <button id="load-custom-bios-button">Load BIOS</button>
            </div>
            <div>
                <label for="custom-vga-bios-file-input">Custom VGA BIOS:</label>
                <input type="file" id="custom-vga-bios-file-input" accept=".bin" style="display: none;">
                <button id="load-custom-vga-bios-button">Load VGA BIOS</button>
            </div>
            <div>
                <label for="cdrom-file-input">CD-ROM ISO:</label>
                <input type="file" id="cdrom-file-input" accept=".iso,.img" style="display: none;">
                <button id="load-cdrom-button">Load CD ISO</button><span id="cdrom-file-name"></span>
            </div>
            <hr>
            <div>
                <label for="fda-file-input">Floppy Image:</label>
                <input type="file" id="fda-file-input" accept=".img,.IMG" />
            </div>
            <div>
                <label for="hd-file-input" style="display:block; margin-top:5px;">Hard Drive Image:</label>
                <input type="file" id="hd-file-input" accept=".img,.IMG" style="display: none;" />
                <button id="load-hd-button">Load HD</button><span id="hd-file-name"></span>
            </div>
            <hr>
            <div>
                <button id="start-fda-button">Boot Floppy</button>
                <button id="start-hd-button">Boot HD</button>
                <button id="start-cdrom-button">Boot CD</button>
            </div>
            <div>
                <button id="start-empty-button">BIOS / Empty</button>
                <button id="reset-emulator-button" style="background-color: #ffe0e0;">Reset Emulator</button>
            </div>
        </div>
        <div id="display-block">
            <div id="top-controls">
                <button id="toggle-fullscreen-button">Toggle Fullscreen</button>
            </div>
            <div id="screen_aspect_wrapper">
                <div id="screen_container">
                    <!-- Emulator display will render here -->
                </div>
            </div>
        </div>
    </div>
    <div id="status-container">
        <div id="status">Please select an image file and click start.</div>
    </div>
</div>
<script src="libv86.js"></script>
<script>
"use strict";
function resizeScreen() {
    const wrapper = document.getElementById('screen_aspect_wrapper');
    const container = document.getElementById('screen_container');
    if (!wrapper || !container) return;
    container.style.width = "100%";
    container.style.height = "100%";
    let canvas = container.querySelector("canvas");
    let textDiv = container.querySelector("div");
    if (canvas) {
        canvas.style.width = "100%";
        canvas.style.height = "100%";
        canvas.style.objectFit = "fill";
    }
    if (textDiv) {
        textDiv.style.width = "100%";
        textDiv.style.height = "100%";
    }
}
window.addEventListener('resize', resizeScreen);
window.addEventListener('DOMContentLoaded', resizeScreen);
setTimeout(resizeScreen, 200);

const startFdaButton = document.getElementById("start-fda-button");
const fdaFileInput = document.getElementById("fda-file-input");
const startHdButton = document.getElementById("start-hd-button");
const hdFileInput = document.getElementById("hd-file-input");
const loadHdButton = document.getElementById("load-hd-button");
const startCdromButton = document.getElementById("start-cdrom-button"); 
const cdromFileInput = document.getElementById("cdrom-file-input");
const loadCdromButton = document.getElementById("load-cdrom-button");
const startEmptyButton = document.getElementById("start-empty-button"); 
const customBiosFileInput = document.getElementById("custom-bios-file-input");
const loadCustomBiosButton = document.getElementById("load-custom-bios-button");
const customVgaBiosFileInput = document.getElementById("custom-vga-bios-file-input"); 
const loadCustomVgaBiosButton = document.getElementById("load-custom-vga-bios-button");
const resetEmulatorButton = document.getElementById("reset-emulator-button"); 
const toggleFullscreenButton = document.getElementById("toggle-fullscreen-button");
const screenContainer = document.getElementById("screen_container");
const statusDiv = document.getElementById("status"); 
const enableSoundCheckbox = document.getElementById("enable-sound-checkbox");
const brightnessSlider = document.getElementById("brightness-slider");
// SB16 controls
const sb16IrqSelect = document.getElementById("sb16-irq-select");
const sb16Dma8Select = document.getElementById("sb16-dma8-select");
const sb16Dma16Select = document.getElementById("sb16-dma16-select");
const sb16PortSelect = document.getElementById("sb16-port-select");

// Brightness handler
brightnessSlider.addEventListener("input", (event) => {
    const brightnessValue = event.target.value;
    const canvasElement = screenContainer.getElementsByTagName("canvas")[0];
    const textModeDiv = screenContainer.getElementsByTagName("div")[0];
    if (canvasElement) {
        canvasElement.style.filter = `brightness(${brightnessValue})`;
    }
    if (textModeDiv) {
        textModeDiv.style.filter = `brightness(${brightnessValue})`;
    }
});

let emulator = null; 
let hdaBuffer = null; 
let customBiosBuffer = null; 
let customVgaBiosBuffer = null; 
let cdromIsoBuffer = null;
let screenWakeLockSentinel = null;

async function requestScreenWakeLock() {
    if ('wakeLock' in navigator) {
        try {
            screenWakeLockSentinel = await navigator.wakeLock.request('screen');
            if (statusDiv.textContent.length > 0 && !statusDiv.textContent.includes("wake lock active")) {
                statusDiv.textContent += " (Screen wake lock active)";
            }
            screenWakeLockSentinel.addEventListener('release', () => {
                screenWakeLockSentinel = null; 
            });
        } catch (err) {
            screenWakeLockSentinel = null;
        }
    }
}
async function releaseScreenWakeLock() {
    if (screenWakeLockSentinel) {
        try {
            await screenWakeLockSentinel.release();
        } catch (err) {
            screenWakeLockSentinel = null; 
        }
    }
}

async function initializeAndRunEmulator(config, statusMsg) { 
    if (emulator) {
        try { 
            await releaseScreenWakeLock(); 
            emulator.destroy(); 
        } catch (err) { }
        emulator = null;
        screenContainer.innerHTML = '<div style="white-space: pre; font: 14px monospace; line-height: 14px"></div><canvas style="display: none"></canvas>';
    }
    emulator = new V86(config);

    emulator.add_listener("emulator-loaded", () => { statusDiv.textContent = "Emulator loaded. Booting..."; });
    emulator.add_listener("emulator-started", async () => { 
        statusDiv.textContent = statusMsg;
        await requestScreenWakeLock(); 
    });
    emulator.add_listener("emulator-stopped", async () => { 
        statusDiv.textContent = "Emulator stopped. Select an image and click start to run again.";
        await releaseScreenWakeLock(); 
    });
    emulator.add_listener("download-error", (err) => {
        statusDiv.textContent = "Emulator download error: " + (err.request?.statusText || "File download failed");
    });
    const generalEmulatorErrorHandler = (event_name) => async (err) => { 
        statusDiv.textContent = `Emulator error (${event_name}): ${err && err.message ? err.message : String(err)}`;
        await releaseScreenWakeLock(); 
    };
    ["error", "nmi"].forEach(event_name => { 
        emulator.add_listener(event_name, generalEmulatorErrorHandler(event_name));
    });
    emulator.add_listener("acpi-event", () => { });
    emulator.add_listener("acpi-debug", () => { });
    setTimeout(resizeScreen, 250);
}
function getBaseEmulatorConfig() {
    // Only working features included (SB16, sound, bios, drives)
    // SB16 config object
    const sb16Config = {
        irq: Number(sb16IrqSelect.value),
        dma8: Number(sb16Dma8Select.value),
        dma16: Number(sb16Dma16Select.value),
        port: Number(sb16PortSelect.value)
    };

    let baseEmuConfig = {
        wasm_path: "v86.wasm",
        screen_container: screenContainer,
        autostart: true,
        sb16: sb16Config,
    };
    if (customBiosBuffer) {
        baseEmuConfig.bios = { buffer: customBiosBuffer };
    } else {
        baseEmuConfig.bios = { url: "bios/seabios.bin" };
    }
    if (customVgaBiosBuffer) {
        baseEmuConfig.vga_bios = { buffer: customVgaBiosBuffer };
    } else {
        baseEmuConfig.vga_bios = { url: "bios/vgabios.bin" };
    }
    if (!enableSoundCheckbox.checked) {
        baseEmuConfig.disable_audio = true;
    }
    return {
        config: baseEmuConfig,
    };
}
startFdaButton.addEventListener("click", async () => { 
    if (fdaFileInput.files.length === 0) {
        alert("Please select a floppy disk image to use the 'Boot Floppy' button.");
        return;
    }
    const file = fdaFileInput.files[0];
    statusDiv.textContent = "Reading floppy disk image: " + file.name;
    const reader = new FileReader();
    reader.onload = async (e) => { 
        const fda_buffer = e.target.result;
        statusDiv.textContent = "Floppy disk loaded. Preparing emulator...";
        const baseConfigInfo = getBaseEmulatorConfig();
        let emuConfig = { ...baseConfigInfo.config, fda: { buffer: fda_buffer }, boot_order: 0 };
        if (hdaBuffer) { emuConfig.hda = { buffer: hdaBuffer }; }
        if (cdromIsoBuffer) { emuConfig.cdrom = { buffer: cdromIsoBuffer }; }
        await initializeAndRunEmulator(emuConfig, "Emulator booting from Floppy: " + file.name);
    };
    reader.onerror = () => { alert("Error reading floppy file."); statusDiv.textContent = "Error reading floppy file."; };
    reader.readAsArrayBuffer(file);
});
startHdButton.addEventListener("click", async () => { 
    if (!hdaBuffer) {
        alert("Please load a hard drive image first.");
        return;
    }
    statusDiv.textContent = "Preparing emulator to boot from Hard Drive...";
    const baseConfigInfo = getBaseEmulatorConfig();
    let emuConfig = { ...baseConfigInfo.config, hda: { buffer: hdaBuffer }, boot_order: 1 };
    if (cdromIsoBuffer) { emuConfig.cdrom = { buffer: cdromIsoBuffer }; }
    await initializeAndRunEmulator(emuConfig, "Emulator booting from Hard Drive");
});
startCdromButton.addEventListener("click", async () => { 
    if (!cdromIsoBuffer) {
        alert("Please load a CD-ROM ISO first.");
        return;
    }
    statusDiv.textContent = "Preparing emulator to boot from CD-ROM...";
    const baseConfigInfo = getBaseEmulatorConfig();
    let emuConfig = { ...baseConfigInfo.config, cdrom: { buffer: cdromIsoBuffer }, boot_order: 2 };
    if (hdaBuffer) { emuConfig.hda = { buffer: hdaBuffer }; }
    await initializeAndRunEmulator(emuConfig, "Emulator booting from CD-ROM");
});
startEmptyButton.addEventListener("click", async () => { 
    statusDiv.textContent = "Preparing to start empty / enter BIOS setup...";
    const baseConfigInfo = getBaseEmulatorConfig();
    let emuConfig = { ...baseConfigInfo.config, boot_order: 0 }; 
    if (cdromIsoBuffer) { emuConfig.cdrom = { buffer: cdromIsoBuffer }; }
    await initializeAndRunEmulator(emuConfig, "Emulator started (empty/BIOS setup)");
});
resetEmulatorButton.addEventListener("click", async function() { 
    if (emulator) {
        try {
            await releaseScreenWakeLock(); 
            emulator.restart();
            statusDiv.textContent = "Emulator restarting...";
            await requestScreenWakeLock(); 
        } catch (e) {
            statusDiv.textContent = "Error restarting emulator. Please use a Boot/Start button.";
        }
    } else {
        statusDiv.textContent = "Emulator is not running.";
        alert("Emulator is not running. Nothing to reset.");
    }
});
toggleFullscreenButton.addEventListener("click", function() {
    if (!document.fullscreenElement) {
        if (screenContainer.requestFullscreen) {
            screenContainer.requestFullscreen();
        } else if (screenContainer.mozRequestFullScreen) {
            screenContainer.mozRequestFullScreen();
        } else if (screenContainer.webkitRequestFullscreen) {
            screenContainer.webkitRequestFullscreen();
        } else if (screenContainer.msRequestFullscreen) {
            screenContainer.msRequestFullscreen();
        } else {
            alert("Fullscreen API is not supported by this browser.");
        }
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
    }
});
document.addEventListener('visibilitychange', async () => {
    if (document.visibilityState === 'visible' && emulator && emulator.is_running && typeof emulator.is_running === 'function' && emulator.is_running()) { 
        if (!screenWakeLockSentinel) {
            await requestScreenWakeLock();
        }
    }
});
loadCustomBiosButton.addEventListener("click", () => { customBiosFileInput.click(); });
customBiosFileInput.addEventListener('change', (event) => {
    if (!event.target.files.length) return;
    const file = event.target.files[0];
    statusDiv.textContent = `Reading custom BIOS: ${file.name}...`;
    const reader = new FileReader();
    reader.onload = (e) => {
        customBiosBuffer = e.target.result;
        statusDiv.textContent = `Custom BIOS '${file.name}' loaded. Will be used on next start.`;
        customBiosFileInput.value = "";
    };
    reader.onerror = () => { alert(`Error reading custom BIOS: ${file.name}`); customBiosBuffer = null; statusDiv.textContent = "Error reading custom BIOS."; };
    reader.readAsArrayBuffer(file);
});
loadCustomVgaBiosButton.addEventListener("click", () => { customVgaBiosFileInput.click(); }); 
customVgaBiosFileInput.addEventListener('change', (event) => { 
    if (!event.target.files.length) return;
    const file = event.target.files[0];
    statusDiv.textContent = `Reading custom VGA BIOS: ${file.name}...`;
    const reader = new FileReader();
    reader.onload = (e) => {
        customVgaBiosBuffer = e.target.result;
        statusDiv.textContent = `Custom VGA BIOS '${file.name}' loaded. Will be used on next start.`;
        customVgaBiosFileInput.value = "";
    };
    reader.onerror = () => { alert(`Error reading custom VGA BIOS: ${file.name}`); customVgaBiosBuffer = null; statusDiv.textContent = "Error reading custom VGA BIOS."; };
    reader.readAsArrayBuffer(file);
});
loadCdromButton.addEventListener("click", () => { cdromFileInput.click(); });
cdromFileInput.addEventListener('change', (event) => {
    if (!event.target.files.length) return;
    const file = event.target.files[0];
    statusDiv.textContent = `Reading CD-ROM ISO: ${file.name}...`;
    const reader = new FileReader();
    reader.onload = (e) => {
        cdromIsoBuffer = e.target.result;
        statusDiv.textContent = `CD-ROM ISO '${file.name}' loaded. Ready for CD-ROM boot.`;
        document.getElementById('cdrom-file-name').textContent = ' (' + file.name + ')';
        cdromFileInput.value = "";
    };
    reader.onerror = () => { alert(`Error reading CD-ROM ISO: ${file.name}`); cdromIsoBuffer = null; statusDiv.textContent = "Error reading CD-ROM ISO."; document.getElementById('cdrom-file-name').textContent = '';};
    reader.readAsArrayBuffer(file);
});
loadHdButton.addEventListener("click", () => { hdFileInput.click(); });
hdFileInput.addEventListener('change', (event) => {
    if (!event.target.files.length) return;
    const file = event.target.files[0];
    statusDiv.textContent = `Reading hard drive image: ${file.name}...`;
    const reader = new FileReader();
    reader.onload = (e) => {
        hdaBuffer = e.target.result;
        statusDiv.textContent = `Hard drive image '${file.name}' loaded.`;
        document.getElementById('hd-file-name').textContent = ' (' + file.name + ')';
        hdFileInput.value = "";
    };
    reader.onerror = () => { alert(`Error reading HDA: ${file.name}`); hdaBuffer = null; statusDiv.textContent = "Error reading HDA."; document.getElementById('hd-file-name').textContent = '';};
    reader.readAsArrayBuffer(file);
});
</script>
</body>
</html>